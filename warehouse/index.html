<!DOCTYPE html>
<html>

<link includeDefault="true">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<link rel="icon" href="publlic/icon/building-fill.png" sizes="16*16" type="image/png">
</link>
<title>3D仓库图显示</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    width: 100vw;
    height: 100vh;
  }
  #label {
      position: absolute;
      padding: 10px;
      background: rgba(255, 255, 255, 0.6);
      line-height: 1;
      border-radius: 5px;
    }
</style>
<!-- threejs-->
<script type="text/javascript" src="js/libs/three.js"></script>
<!-- stats.js -->
<script type="text/javascript" src="js/libs/stats.js"></script>
<!-- OrbitControls -->
<script type="text/javascript" src="js/libs/controls/OrbitControls.js"></script>
<!-- ThreeBsp -->
<script type="text/javascript" src="js/libs/ThreeBSP.js"></script>
<!-- 返回墙对象 -->
<script type="text/javascript" src="js/wallobject.js"></script>
<!-- 墙壁纹理 -->
<script type="text/javascript" src="js/wallTexture.js"></script>
<!-- 安装大门 -->
<script type="text/javascript" src="js/createDoor.js"></script>
<!-- 窗户 -->
<script type="text/javascript" src="js/createWindow.js"></script>
<!-- 事件 -->
<script type="text/javascript" src="js/ThreeJs_Composer.js"></script>
<script type="text/javascript" src="js/libs/jquery-1.11.0.min.js"></script>
<!-- 后期效果处理 -->
<script type="text/javascript" src="js/libs/EffectComposer.js"></script>
<script type="text/javascript" src="js/libs/FXAAShader.js"></script>
<script type="text/javascript" src="js/libs/CopyShader.js"></script>
<script type="text/javascript" src="js/libs/OutlinePass.js"></script>
<script type="text/javascript" src="js/libs/RenderPass.js"></script>
<script type="text/javascript" src="js/libs/ShaderPass.js"></script>
<!-- 补间动画库 -->
<script type="text/javascript" src="js/libs/Tween.js"></script>

</head>

<body>
  <div id="label"></div>
  <div id="Stats-output"></div>
  <div id="canvas"></div>

  <script>

    const scene = new THREE.Scene()
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 10000)
    const renderer = new THREE.WebGLRenderer({ antialias: true })
    var stats = statsInit()
    //创建控件对象
    const controls = new THREE.OrbitControls(camera, renderer.domElement)
    const matArrayB = [] //外墙   
    const matArrayA = []  //用于纹理
    const composer =  new THREE.ThreeJs_Composer(renderer, scene, camera)

    // 场景初始化
    function sceneInit() {
      const scene = new THREE.Scene()
    }
    // 相机初始化
    function cameraInit() {
      camera.position.set(0, 800, 1500)
      camera.lookAt(new THREE.Vector3(0, 0, 0))
    }
    // 初始化灯光
    function lightsInit() {
      // 平行光
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.3)//模拟远处类似太阳的光源
      directionalLight.color.setHSL(0.1, 1, 0.95)
      directionalLight.position.set(0, 200, 0).normalize()
      // 环境光
      const ambient = new THREE.AmbientLight(0xffffff, 1) //AmbientLight,影响整个场景的光源
      ambient.position.set(0, 0, 0)
      scene.add(directionalLight, ambient)
    }
    // stats监测插件
    function statsInit() {
      const stats = new Stats()
      stats.domElement.style.position = 'absolute'
      stats.domElement.style.left = '0px'
      stats.domElement.style.top = '0px'
      stats.showPanel(1); // 0: fps, 1: ms, 2: mb, 3+: custom
      document.getElementById("Stats-output").appendChild(stats.domElement)
      return stats
    }

    // 控制器
    const ControlsInit = () => {
      controls.enableDamping = true;
      controls.dampingFactor = 0.5;
      // 视角最小距离
      controls.minDistance = 100;
      // 视角最远距离
      controls.maxDistance = 5000;
      // 最大角度
      controls.maxPolarAngle = Math.PI / 2.2;
    }

    // 渲染器初始化
    function rendererInit() {
      renderer.setSize(window.innerWidth, window.innerHeight)
      renderer.setClearColor(0x4682B4, 1.0)
      document.getElementById("canvas").appendChild(renderer.domElement)
    }

    // 地板
    const createFloor = () => {
      const textureloader = new THREE.TextureLoader() //加载器
      textureloader.load('publlic/images/floor.jpg', function (texture) {
        // 设置阵列模式  
        // 默认ClampToEdgeWrapping  RepeatWrapping：阵列  
        // 镜像阵列：MirroredRepeatWrapping
        texture.wrapS = THREE.RepeatWrapping
        texture.wrapT = THREE.RepeatWrapping
        // uv两个方向纹理重复数量
        texture.repeat.set(10, 10)
        // 几何体
        const floorgeometry = new THREE.BoxBufferGeometry(2600, 1400, 1)
        // 材质
        const floormaterial = new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide })
        // 网格模型
        const mesh = new THREE.Mesh(floorgeometry, floormaterial)
        // 位置
        mesh.position.y = -0.5
        mesh.rotation.x = Math.PI / 2;
        scene.add(mesh)
      })
    }

    //创建墙壁
    const createWall = (width, height, depth, angle, x, y, z, name) => {
      const wallGeometry = new THREE.BoxBufferGeometry(width, height, depth)
      const wallMaterial = new THREE.MeshPhongMaterial({ color: 0xafc0ca })
      const wallcube = new THREE.Mesh(wallGeometry, wallMaterial)

      wallcube.position.x = x;
      wallcube.position.y = y;
      wallcube.position.z = z;
      wallcube.rotation.y += angle * Math.PI;  //-逆时针旋转,+顺时针
      wallcube.name = name;
      scene.add(wallcube);
    }

    // 创建出挖去门窗的墙面,第一个参数是被挖去的墙，第二个是要挖去的物体的数组
    //墙上挖门窗，通过两个几何体生成BSP对象
    function createWallBsp(bsp, objects_cube) {
      var material = new THREE.MeshPhongMaterial({
        color: 0x9cb2d1,
        specular: 0x9cb2d1,
        shininess: 30,
        transparent: true,
        opacity: 1
      });
      var BSP = new ThreeBSP(bsp);
      for (var i = 0; i < objects_cube.length; i++) {
        var less_bsp = new ThreeBSP(objects_cube[i]);
        BSP = BSP.subtract(less_bsp);
      }
      var result = BSP.toMesh(material);
      result.material.flatshading = THREE.FlatShading;
      result.geometry.computeFaceNormals(); //重新计算几何体侧面法向量
      result.geometry.computeVertexNormals();
      result.material.needsUpdate = true; //更新纹理
      result.geometry.buffersNeedUpdate = true;
      result.geometry.uvsNeedUpdate = true;
      scene.add(result);
    }

    // 创建挖去门窗的墙壁
    function createFrontWall() {
      // 创建了一个数组objects_cube来存放要挖去的内容
      var objects_cube = []
      var frontCubWall = returnWallObject(2600, 200, 10, 0, matArrayB, 0, 100, 700, "墙面")
      var door_cube1 = returnWallObject(200, 180, 10, 0, matArrayB, -600, 90, 700, "前门1")
      var door_cube2 = returnWallObject(200, 180, 10, 0, matArrayB, 600, 90, 700, "前门2")
      var window_cube1 = returnWallObject(100, 100, 10, 0, matArrayB, -900, 90, 700, "窗户1")
      var window_cube2 = returnWallObject(100, 100, 10, 0, matArrayB, 900, 90, 700, "窗户2")
      var window_cube3 = returnWallObject(100, 100, 10, 0, matArrayB, -200, 90, 700, "窗户3")
      var window_cube4 = returnWallObject(100, 100, 10, 0, matArrayB, 200, 90, 700, "窗户4")

      objects_cube.push(door_cube1)
      objects_cube.push(door_cube2)
      objects_cube.push(window_cube1)
      objects_cube.push(window_cube2)
      objects_cube.push(window_cube3)
      objects_cube.push(window_cube4)
      createWallBsp(frontCubWall, objects_cube)
    }

    // 创建三面实体墙壁+前部门窗墙壁+纹理
    const createcubWall = () => {
      Promise.all([createWall(10, 200, 1400, 0, -1295, 100, 0, "墙面"),
      createWall(10, 200, 1400, 0, -1295, 100, 0, "墙面"),
      createWall(10, 200, 1400, 1, 1295, 100, 0, "墙面"),
      createWall(10, 200, 2600, 1.5, 0, 100, -700, "墙面"),
      createFrontWall(),   //创建带窗户门的墙壁
      createWallTexture(),  // 纹理
      createLeftDoor(100, 180, 2, 0, -700, 90, 700, "左门1"),  //左门1
      createLeftDoor(100, 180, 2, 0, 500, 90, 700, "左门2"),  //左门2
      createRightDoor(100, 180, 2, 0, -500, 90, 700, "右门1"), //右门1
      createRightDoor(100, 180, 2, 0, 700, 90, 700, "右门2"),  // 右门2
      createWindow(100, 100, 2, 0, -900, 90, 700, "窗户"),
      createWindow(100, 100, 2, 0, 900, 90, 700, "窗户"),
      createWindow(100, 100, 2, 0, -200, 90, 700, "窗户"),
      createWindow(100, 100, 2, 0, 200, 90, 700, "窗户")
      ])
    }

    // 初始化
    const Init = async () => {
      await sceneInit()
      await cameraInit()
      await lightsInit()
      await statsInit()
      await rendererInit()
      await ControlsInit()
      await createFloor() //创建地板
      await createcubWall() //创建墙壁
    }
    // animate
    const renderScene = async () => {
      //通知stats画面已被重新渲染了
      await stats.update()
      await controls.update()
      //通过requestAnimationFrame方法在特定时间间隔重新渲染场景
      await requestAnimationFrame(renderScene)
      await composer.render()//事件操作
      await TWEEN.update() // 动画刷新
      await renderer.render(scene, camera)
    }


    window.onload = function () {
      Init()
      renderScene()
    }
  </script>
</body>

</html>